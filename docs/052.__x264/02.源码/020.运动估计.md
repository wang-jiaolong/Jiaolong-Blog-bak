---
title: 运动估计
date: 2022-10-09 15:55:12
permalink: /pages/e6fe7b/
sidebar: true
categories: 
  - null
tags: 
  - null
hidden: true
---

运动估计是在参考帧中为当前编码的宏块寻找最佳匹配快，找到最佳匹配块后，运动估计会输出是运动矢量。

运动估计的下一步是运动补偿(Motion Compensation)，即从当前块中减去匹配块得到残差块。在整个编码过程中，运动估计耗时占了整个编码过程的60%-80%不等，因此，对运动估计的优化是实现视频实时应用的关键。

H264 中运动估计的过程分为两步：

1. 整数像素精度的估计。

2. 分数像素级精度的估计。


其中整数像素级的运动估计包括两类算法：全搜索算法、快速搜索算法(DIA/HEX/UMH)。

几个运动估计中用到的缩写：

- MV: 运动矢量。被用来表示一个宏块基于该宏块中的另一个图像的位置。
- MVP:预测运动矢量。
- MVD：两个运动矢量的差值。
- SATD(Sum of Absolute Transformed Difference):即 hadamard 变换后再绝对值求和。
- SSD(Sum of Squared Difference) = SSE(Sum of Squared Error) 即差值的平方和。
- MAD(Mean Absolute Difference) = MAE(Mean Absolute Error) 即平均绝对差值。
- MSD(Mean Squared Difference) = MSE(Mean Squared Error) 即平均平方误差。

## x264_me_search_ref()

进行运动估计，计算cost来选择最小的运动估计方法



运动估计的方法主要分为光流方 程法、像素递归法、块匹配方法和网格法，其中基于块匹配方法的运动估计 由于思想容易理解，操作便于实现，逐渐成为运动估计的主流研究方法。

## 搜索模式



```
//x264 包含算法
#define X264_ME_DIA                  0
#define X264_ME_HEX                  1
#define X264_ME_UMH                  2
#define X264_ME_ESA                  3
#define X264_ME_TESA                 4
```

### 1. 菱形搜索算法（DIA）

在块匹配过程中，步长的大小对于搜索过程起到了至关重要的作用。通常，搜索步长 越大，误差越大；搜索步长过小，则容易陷入局部最优。针对这个问题，菱形搜索法(Diamond search)[ 10]采用大、小两种模板。开始搜索时，采用由9个点组成大模板，当最 佳匹配点位于模板中心时，则采用由5个点组成的小模板进行搜索，搜索过程如图2.6所 示。

![image.png](https://s2.loli.net/2022/10/23/cmtqU6GjJRyrWT5.png)

### 2. 六边形搜索算法（HEX）

该方法采用1个大模板（六边形模板）和2个小模板（小菱形模板和小正方形模板）。具体的搜索步骤如下：
步骤1：以搜索起点为中心，采用图中左边的六边形模板进行搜索。计算区域中心及周围6个点处的匹配误差并比较，如最小MBD 点位于模板中心点，则转至步骤2；否则以上一次的MBD 点作为中心点，以六边形模板为模板进行反复搜索。
步骤2：以上一次的MBD 点为中心点，采用小菱形模板搜索，计算各点的匹配误差，找到MBD 点。然后以MBD点为中心点，采用小正方形模板搜索，得到的MBD点就是最优匹配点。

### 3. 非对称十字型多层次六边形搜索算法（UMH）

运动估计中，起始搜索点和提前终止技术非常重要。UMH 算法是基于 MV 具有时空相关性，因此可以结合上一帧和上一步中 MV 的方向和角度，来修改多层六边形的形状。

步骤0：进行一次小菱形搜索，根据匹配误差值和两个门限值（对于一种尺寸的宏块来说是固定大小的threshold1和threshold2）之间的关系作相应的处理，可能用到中菱形模板或者正八边形模板，也有可能直接跳到步骤1。
步骤1：使用非对称十字模板搜索。“非对称”的原因是一般水平方向运动要比垂直方向运动剧烈，所以将水平方向搜索范围定为W，垂直方向搜索范围定为W/2。
步骤2：使用5x5逐步搜索模板搜索。
步骤3：使用大六边形模板搜索。
步骤4：使用六边形搜索算法找到最优匹配点。









### 4. 连续消除法（ESA、TESA）

该方法是一种全搜索算法，它对搜索区域内的点进行光栅式搜索，逐一计算并比较。

### 评估比较

论文《X264的运动估计算法研究》中曾经评测了几种运动搜索算法的性能。文中采用了“Foreman”（运动剧烈）、“Carphone”（中等运动）、“Claire”（运动较小）几个视频作为实验素材，搜索范围为设置为16，实验的结果如下表所示。

![image.png](https://s2.loli.net/2022/10/23/cmtqU6GjJRyrWT5.png)

从结果可以看出，码率不变的前提下，“Dia”、“HEX”、“UMH”、“ESA”编码获得的质量依次提高，速度依次降低。其中快速算法（“Dia”、“HEX”、“UMH”）的编码质量比全搜索算法（“ESA”）低不了太多，但是速度却高了很多倍。
